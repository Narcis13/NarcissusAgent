---
phase: 03-ai-supervisor
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/supervisor/prompt.ts
  - src/supervisor/claude.ts
  - src/supervisor/index.ts
autonomous: true

must_haves:
  truths:
    - "Prompt includes iteration count with format: Iteration N/M"
    - "Supervisor enforces iteration budget with hard stop at limit"
    - "createClaudeSupervisor returns function compatible with HooksController.setSupervisor()"
  artifacts:
    - path: "src/supervisor/prompt.ts"
      provides: "Supervisor prompt template builder"
      exports: ["buildSupervisorPrompt"]
    - path: "src/supervisor/claude.ts"
      provides: "Factory function for Claude supervisor"
      exports: ["createClaudeSupervisor"]
    - path: "src/supervisor/index.ts"
      provides: "Module re-exports"
      exports: ["createClaudeSupervisor", "createMockSupervisor"]
  key_links:
    - from: "src/supervisor/claude.ts"
      to: "src/supervisor/spawn.ts"
      via: "spawnSupervisor call"
      pattern: "spawnSupervisor\\("
    - from: "src/supervisor/claude.ts"
      to: "src/supervisor/parse.ts"
      via: "parseResponse call"
      pattern: "parseResponse\\("
    - from: "src/supervisor/claude.ts"
      to: "src/hooks/controller.ts"
      via: "SupervisorFn type compatibility"
      pattern: "SupervisorFn"
---

<objective>
Create prompt builder and factory function with iteration budget enforcement.

Purpose: Complete the Claude supervisor implementation that can be injected into HooksController.

Output: Prompt template builder, createClaudeSupervisor factory, and updated module exports.
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-ai-supervisor/03-CONTEXT.md
@.planning/phases/03-ai-supervisor/03-RESEARCH.md
@src/supervisor/types.ts
@src/supervisor/spawn.ts
@src/supervisor/parse.ts
@src/hooks/controller.ts
@src/hooks/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prompt builder</name>
  <files>src/supervisor/prompt.ts</files>
  <action>
Create the supervisor prompt template builder:

```typescript
/**
 * Supervisor Prompt Builder
 *
 * Constructs context-rich prompts for supervisor decisions.
 */
import type { SupervisorContext } from "./types";

/**
 * Build supervisor prompt from context
 *
 * Includes:
 * - Task description
 * - Iteration count (N/M format)
 * - Recent tool history (last 10, truncated)
 * - Clear instructions for marker response format
 *
 * @param context - SupervisorContext with task, tools, and iteration info
 * @returns Formatted prompt string for claude -p
 */
export function buildSupervisorPrompt(context: SupervisorContext): string {
  // Format tool history - last 10 entries, truncated output
  const toolSummary = context.toolHistory.slice(-10).map((t, i) => {
    const status = t.error ? `ERROR: ${t.error.slice(0, 50)}` : 'OK';
    const snippet = t.output.slice(0, 150).replace(/\n/g, ' ');
    return `[${i + 1}] ${t.toolName} (${status}): ${snippet}`;
  }).join('\n');

  return `You supervise a Claude Code instance working on a task.

TASK: ${context.taskDescription}

ITERATION: ${context.iterationCount}/${context.maxIterations}

RECENT TOOL ACTIVITY:
${toolSummary || '(no tools executed yet)'}

Based on this information, decide the next action:

- If the work is COMPLETE (task accomplished, no more work needed):
  Respond with [COMPLETE] followed by a brief summary.

- If something is WRONG and we should STOP (errors, wrong direction, stuck):
  Respond with [ABORT] followed by the reason.

- If work should CONTINUE (more steps needed):
  Respond with [CONTINUE] followed by the instruction to give the inner Claude.

Respond with ONLY the marker and content. No additional explanation.

Example responses:
[COMPLETE] Successfully implemented the authentication flow with JWT tokens.
[ABORT] Inner Claude is stuck in a loop creating the same file repeatedly.
[CONTINUE] Now write the unit tests for the auth module.`;
}
```

Key patterns:
- Iteration count in "N/M" format for budget awareness
- Tool history truncated to last 10 entries
- Output snippets truncated to 150 chars
- Clear marker instructions with examples
  </action>
  <verify>bun build src/supervisor/prompt.ts --target=bun</verify>
  <done>prompt.ts exports buildSupervisorPrompt that includes iteration count in N/M format</done>
</task>

<task type="auto">
  <name>Task 2: Create Claude supervisor factory</name>
  <files>src/supervisor/claude.ts</files>
  <action>
Create the factory function that produces a SupervisorFn:

```typescript
/**
 * Claude Supervisor Factory
 *
 * Creates a supervisor function that spawns claude -p for decisions.
 */
import type { SupervisorFn } from "../hooks/controller";
import type { SupervisorDecision } from "../hooks/types";
import type { ClaudeSupervisorConfig } from "./types";
import { spawnSupervisor } from "./spawn";
import { parseResponse } from "./parse";
import { buildSupervisorPrompt } from "./prompt";

const DEFAULT_MAX_ITERATIONS = 50;
const DEFAULT_TIMEOUT = 30000;

/**
 * Create a Claude Code CLI supervisor function
 *
 * Spawns a fresh `claude -p` process for each decision.
 * Tracks iteration count in closure and enforces budget.
 *
 * @param config - Optional configuration (maxIterations, timeout)
 * @returns SupervisorFn compatible with HooksController.setSupervisor()
 */
export function createClaudeSupervisor(config: ClaudeSupervisorConfig = {}): SupervisorFn {
  const {
    maxIterations = DEFAULT_MAX_ITERATIONS,
    timeout = DEFAULT_TIMEOUT,
  } = config;

  let iterationCount = 0;

  return async (context): Promise<SupervisorDecision> => {
    iterationCount++;

    // Enforce iteration budget - hard stop at limit
    if (iterationCount >= maxIterations) {
      console.log(`[Supervisor] Iteration budget exhausted (${iterationCount}/${maxIterations})`);
      return {
        action: 'abort',
        command: '/clear',
        reason: `Iteration budget exhausted (${iterationCount}/${maxIterations})`,
        confidence: 1.0,
      };
    }

    // Build prompt with iteration context
    const prompt = buildSupervisorPrompt({
      taskDescription: context.taskDescription,
      toolHistory: context.toolHistory,
      sessionId: context.sessionId,
      iterationCount,
      maxIterations,
    });

    // Spawn supervisor process
    const result = await spawnSupervisor(prompt, timeout);

    // Handle spawn failures - continue monitoring
    if (result.exitCode !== 0) {
      console.error('[Supervisor] Process exited with code:', result.exitCode);
      console.error('[Supervisor] Error:', result.error);
      return {
        action: 'continue',
        reason: `Supervisor error (exit ${result.exitCode}), resuming monitoring`,
        confidence: 0.5,
      };
    }

    // Parse response and map to SupervisorDecision
    const parsed = parseResponse(result.output);

    switch (parsed.action) {
      case 'complete':
        return {
          action: 'stop',
          reason: parsed.content || 'Work complete',
          confidence: 0.9,
        };

      case 'abort':
        return {
          action: 'abort',
          command: '/clear',  // Clean up inner Claude context
          reason: parsed.content || 'Aborted by supervisor',
          confidence: 0.9,
        };

      case 'continue':
        return {
          action: 'inject',
          command: parsed.content,
          reason: 'Supervisor continues work',
          confidence: 0.8,
        };
    }
  };
}
```

Key behaviors:
- Tracks iterations in closure (state persists across calls)
- Hard stop at maxIterations with abort + /clear
- Maps parsed actions to SupervisorDecision types
- On supervisor error, returns 'continue' to resume monitoring
- /clear command injected on abort for clean state
  </action>
  <verify>bun build src/supervisor/claude.ts --target=bun</verify>
  <done>claude.ts exports createClaudeSupervisor factory that enforces iteration budget</done>
</task>

<task type="auto">
  <name>Task 3: Update module exports</name>
  <files>src/supervisor/index.ts</files>
  <action>
Update the supervisor module index to export new implementations:

```typescript
/**
 * Supervisor Module
 *
 * Exports supervisor implementations and utilities.
 */

// Mock supervisor for testing
export { createMockSupervisor } from "./mock";
export type { MockSupervisorOptions } from "./mock";

// Claude CLI supervisor (production)
export { createClaudeSupervisor } from "./claude";

// Types
export type {
  SupervisorContext,
  SpawnResult,
  ParsedResponse,
  ClaudeSupervisorConfig,
} from "./types";

// Internal utilities (exported for testing/advanced use)
export { spawnSupervisor } from "./spawn";
export { parseResponse } from "./parse";
export { buildSupervisorPrompt } from "./prompt";
```

Export order:
1. Mock (for testing)
2. Claude (production)
3. Types
4. Internal utilities (for testing/advanced use)
  </action>
  <verify>bun -e "import { createClaudeSupervisor, createMockSupervisor } from './src/supervisor'; console.log('Exports OK')"</verify>
  <done>index.ts exports createClaudeSupervisor, createMockSupervisor, and types</done>
</task>

</tasks>

<verification>
```bash
# All modules compile
bun build src/supervisor/prompt.ts --target=bun
bun build src/supervisor/claude.ts --target=bun
bun build src/supervisor/index.ts --target=bun

# Full import test
bun -e "
import { createClaudeSupervisor, createMockSupervisor, buildSupervisorPrompt } from './src/supervisor';
console.log('createClaudeSupervisor:', typeof createClaudeSupervisor);
console.log('createMockSupervisor:', typeof createMockSupervisor);
console.log('buildSupervisorPrompt:', typeof buildSupervisorPrompt);
"
```
</verification>

<success_criteria>
1. prompt.ts exports buildSupervisorPrompt with iteration "N/M" format
2. claude.ts exports createClaudeSupervisor that:
   - Tracks iterations in closure
   - Hard stops at maxIterations (default 50)
   - Spawns claude -p per decision
   - Maps [COMPLETE] -> stop, [ABORT] -> abort + /clear, [CONTINUE] -> inject
3. index.ts exports both createClaudeSupervisor and createMockSupervisor
4. All modules compile and import correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-supervisor/03-02-SUMMARY.md`
</output>
