---
phase: 03-ai-supervisor
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/index.ts
  - src/types.ts
autonomous: true

must_haves:
  truths:
    - "User runs CLI and it uses real Claude supervisor by default (production mode)"
    - "User can switch to mock supervisor with --mock-supervisor flag for testing"
    - "User can configure iteration budget with --max-iterations flag"
  artifacts:
    - path: "src/index.ts"
      provides: "CLI entry point with real supervisor"
      contains: "createClaudeSupervisor"
    - path: "src/types.ts"
      provides: "Re-exports supervisor types"
      exports: ["createClaudeSupervisor", "ClaudeSupervisorConfig"]
  key_links:
    - from: "src/index.ts"
      to: "src/supervisor/claude.ts"
      via: "createClaudeSupervisor import and call"
      pattern: "createClaudeSupervisor\\("
    - from: "src/index.ts"
      to: "hooksController.setSupervisor"
      via: "dependency injection"
      pattern: "setSupervisor\\(.*createClaudeSupervisor"
---

<objective>
Wire Claude supervisor into CLI entry point, replacing mock supervisor.

Purpose: Enable autonomous Claude-supervising-Claude loop in production.

Output: Updated CLI that uses real supervisor with iteration budget enforcement.
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-ai-supervisor/03-CONTEXT.md
@src/index.ts
@src/supervisor/index.ts
@src/supervisor/claude.ts
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CLI to use Claude supervisor</name>
  <files>src/index.ts</files>
  <action>
Update the CLI entry point to use createClaudeSupervisor instead of mock:

1. Change import from:
   ```typescript
   import { createMockSupervisor } from "./supervisor";
   ```
   To:
   ```typescript
   import { createClaudeSupervisor, createMockSupervisor } from "./supervisor";
   ```

2. Add CLI flag for supervisor mode. Add to parseArgs options:
   ```typescript
   "mock-supervisor": { type: "boolean", default: false },
   "max-iterations": { type: "string", default: "50" },
   ```

3. Update help text to document new flags:
   ```
   --mock-supervisor     Use mock supervisor (for testing)
   --max-iterations <n>  Maximum supervisor iterations (default: 50)
   ```

4. Replace the mock supervisor setup line:
   ```typescript
   // OLD:
   hooksController.setSupervisor(createMockSupervisor({ delay: 100 }));

   // NEW:
   const useMockSupervisor = values["mock-supervisor"] ?? false;
   const maxIterations = parseInt(values["max-iterations"] ?? "50", 10);

   if (useMockSupervisor) {
     hooksController.setSupervisor(createMockSupervisor({ delay: 100 }));
     debugLog("Using mock supervisor");
   } else {
     hooksController.setSupervisor(createClaudeSupervisor({ maxIterations }));
     debugLog("Using Claude supervisor", { maxIterations });
   }
   ```

5. Add logging for supervisor decisions. The existing onSupervisorDecision handler already logs via debugLog - verify it includes confidence and reasoning. Ensure supervisor failure messages are visible in logs.

Key changes:
- Default to real Claude supervisor (production mode)
- --mock-supervisor flag for testing/development
- --max-iterations to configure budget
- Debug logging shows supervisor mode at startup
  </action>
  <verify>bun build src/index.ts --target=bun && bun run src/index.ts --help | grep -E "(mock-supervisor|max-iterations)"</verify>
  <done>CLI defaults to createClaudeSupervisor with --mock-supervisor fallback and --max-iterations config</done>
</task>

<task type="auto">
  <name>Task 2: Update types re-exports</name>
  <files>src/types.ts</files>
  <action>
Add supervisor types to the central types re-export file:

Add after the existing loop exports:
```typescript
// Supervisor types
export { createClaudeSupervisor, createMockSupervisor } from "./supervisor";
export type {
  SupervisorContext,
  ClaudeSupervisorConfig,
} from "./supervisor";
```

This allows convenient imports like:
```typescript
import { createClaudeSupervisor, type ClaudeSupervisorConfig } from "./types";
```
  </action>
  <verify>bun -e "import { createClaudeSupervisor, createMockSupervisor } from './src/types'; console.log('Re-exports OK')"</verify>
  <done>types.ts re-exports createClaudeSupervisor and related types</done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
bun build src/index.ts --target=bun

# Help shows new options
bun run src/index.ts --help | grep -E "(mock-supervisor|max-iterations)"

# Import chain works
bun -e "
import { createClaudeSupervisor } from './src/supervisor';
import { HooksController } from './src/hooks';

const ctrl = new HooksController();
ctrl.setSupervisor(createClaudeSupervisor({ maxIterations: 10 }));
console.log('Integration OK');
"

# Verify failure logging is in place (check claude.ts has console.error for failures)
grep -n "console.error.*Supervisor.*failure" src/supervisor/claude.ts || echo "Add failure logging"
```
</verification>

<success_criteria>
1. CLI defaults to Claude supervisor (not mock)
2. --mock-supervisor flag switches to mock for testing
3. --max-iterations configures iteration budget (default 50)
4. Help text documents new options
5. types.ts re-exports supervisor types for convenient imports
6. Full build completes without errors
7. Supervisor failures are logged with failure count visible
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-supervisor/03-03-SUMMARY.md`
</output>
