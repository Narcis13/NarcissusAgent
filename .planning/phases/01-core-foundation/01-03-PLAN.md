---
phase: 01-core-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/session/manager.ts
  - src/session/store.ts
  - src/session/index.ts
  - src/server/routes.ts
  - src/server/index.ts
autonomous: true

must_haves:
  truths:
    - "Session state transitions follow VALID_TRANSITIONS rules"
    - "Invalid transitions throw descriptive errors"
    - "GET /api/session returns current state and metadata as JSON"
    - "Runtime is calculated as milliseconds since startTime"
  artifacts:
    - src/session/manager.ts
    - src/session/store.ts
    - src/session/index.ts
    - src/server/routes.ts
    - src/server/index.ts
  key_links:
    - "SessionManager uses VALID_TRANSITIONS from types"
    - "Hono routes import from session module"
    - "SessionStore is singleton pattern for shared state"
---

<objective>
Implement SessionManager with type-safe state machine and Hono REST API for session status.

Purpose: Session state tracking is critical for the autonomous loop. The REST API enables Phase 4 web UI and debugging. These components are independent of PTY Manager and can be built in parallel.

Output: Working session management with REST endpoint returning session info.
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-foundation/01-RESEARCH.md
@src/session/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SessionManager with state machine</name>
  <files>src/session/manager.ts, src/session/store.ts, src/session/index.ts</files>
  <action>
    **src/session/store.ts** - Singleton store for session state:
    ```typescript
    import type { SessionState, SessionMetadata } from "./types";

    class SessionStore {
      private state: SessionState = { status: "idle" };
      private metadata: SessionMetadata | null = null;

      getState(): Readonly<SessionState> {
        return this.state;
      }

      setState(state: SessionState): void {
        this.state = state;
      }

      getMetadata(): Readonly<SessionMetadata> | null {
        return this.metadata;
      }

      setMetadata(metadata: SessionMetadata | null): void {
        this.metadata = metadata;
      }

      getRuntime(): number {
        if (!this.metadata) return 0;
        return Date.now() - this.metadata.startTime.getTime();
      }
    }

    // Singleton instance
    export const sessionStore = new SessionStore();
    ```

    **src/session/manager.ts** - State machine with validated transitions:
    ```typescript
    import type { SessionState, SessionStatus, SessionMetadata } from "./types";
    import { VALID_TRANSITIONS } from "./types";
    import { sessionStore } from "./store";

    export class SessionManager {
      transition(newState: SessionState): void {
        const currentStatus = sessionStore.getState().status;
        const validNextStates = VALID_TRANSITIONS[currentStatus];

        if (!validNextStates.includes(newState.status)) {
          throw new Error(
            `Invalid state transition: ${currentStatus} -> ${newState.status}. ` +
            `Valid transitions from ${currentStatus}: ${validNextStates.join(", ")}`
          );
        }

        sessionStore.setState(newState);

        // Update metadata on task_running
        if (newState.status === "task_running") {
          sessionStore.setMetadata({
            taskDescription: newState.taskDescription,
            startTime: newState.startTime,
            runtime: 0,
          });
        }
      }

      startTask(taskDescription: string): void {
        this.transition({
          status: "task_running",
          taskDescription,
          startTime: new Date(),
        });
      }

      setAnalyzing(): void {
        this.transition({ status: "analyzing" });
      }

      setInjecting(command: string): void {
        this.transition({ status: "injecting", command });
      }

      setIdle(): void {
        this.transition({ status: "idle" });
      }

      setError(error: string): void {
        const previousStatus = sessionStore.getState().status;
        sessionStore.setState({
          status: "error",
          error,
          previousStatus,
        });
      }

      getState(): Readonly<SessionState> {
        return sessionStore.getState();
      }

      getMetadata(): Readonly<SessionMetadata> | null {
        const meta = sessionStore.getMetadata();
        if (!meta) return null;
        return {
          ...meta,
          runtime: sessionStore.getRuntime(),
        };
      }

      getInfo(): { state: SessionState; metadata: SessionMetadata | null } {
        return {
          state: this.getState(),
          metadata: this.getMetadata(),
        };
      }
    }

    // Singleton instance
    export const sessionManager = new SessionManager();
    ```

    **src/session/index.ts** - Module exports:
    ```typescript
    export { SessionManager, sessionManager } from "./manager";
    export { sessionStore } from "./store";
    export * from "./types";
    ```
  </action>
  <verify>
    bun run typecheck
    grep -l "VALID_TRANSITIONS" src/session/manager.ts
    grep -l "sessionStore" src/session/manager.ts
  </verify>
  <done>
    - SessionManager validates transitions against VALID_TRANSITIONS
    - Invalid transitions throw descriptive errors
    - Convenience methods: startTask, setAnalyzing, setInjecting, setIdle, setError
    - getInfo() returns complete session info with runtime
    - Singleton instances exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Hono REST API for session info</name>
  <files>src/server/routes.ts, src/server/index.ts</files>
  <action>
    **src/server/routes.ts** - Hono routes:
    ```typescript
    import { Hono } from "hono";
    import { cors } from "hono/cors";
    import { sessionManager } from "../session";

    const app = new Hono();

    // Enable CORS for web UI (Phase 4)
    app.use("/api/*", cors());

    // Health check
    app.get("/api/health", (c) => {
      return c.json({ status: "ok", timestamp: new Date().toISOString() });
    });

    // Session info endpoint (SES-03)
    app.get("/api/session", (c) => {
      const info = sessionManager.getInfo();
      return c.json({
        state: info.state.status,
        stateDetails: info.state,
        metadata: info.metadata
          ? {
              taskDescription: info.metadata.taskDescription,
              startTime: info.metadata.startTime.toISOString(),
              runtime: info.metadata.runtime,
              runtimeFormatted: formatRuntime(info.metadata.runtime),
            }
          : null,
      });
    });

    function formatRuntime(ms: number): string {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);

      if (hours > 0) {
        return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
      }
      if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
      }
      return `${seconds}s`;
    }

    export { app };
    ```

    **src/server/index.ts** - Server setup:
    ```typescript
    import { app } from "./routes";

    export function createServer(port: number = 3000) {
      return {
        port,
        fetch: app.fetch,
      };
    }

    export { app };
    ```
  </action>
  <verify>
    bun run typecheck
    grep -l "sessionManager" src/server/routes.ts
    grep -l "/api/session" src/server/routes.ts
  </verify>
  <done>
    - GET /api/session returns session state and metadata
    - GET /api/health returns health check
    - CORS enabled for /api/* routes
    - Runtime formatted for human readability
    - Server can be started with createServer()
  </done>
</task>

</tasks>

<verification>
Run these commands to verify plan completion:

```bash
# Type check passes
bun run typecheck

# Session files exist
ls -la src/session/manager.ts src/session/store.ts src/session/index.ts

# Server files exist
ls -la src/server/routes.ts src/server/index.ts

# Key patterns present
grep "VALID_TRANSITIONS" src/session/manager.ts
grep "/api/session" src/server/routes.ts
```
</verification>

<success_criteria>
1. `bun run typecheck` passes
2. SessionManager validates state transitions
3. Invalid transitions throw descriptive error messages
4. GET /api/session returns JSON with state and metadata
5. Runtime is calculated in milliseconds and formatted
6. CORS enabled for API routes
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-foundation/01-03-SUMMARY.md`
</output>
